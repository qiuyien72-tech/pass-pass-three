<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
      :root {
        --bg-color: #fdfbf7; --card-bg: #ffffff;
        --primary: #ffadad; --secondary: #a0c4ff;
        --accent: #ffd6a5; --text: #4a4e69;
        --danger: #ff6b6b; --safe: #caffbf;
      }
      body {
        font-family: 'Varela Round', sans-serif;
        background-color: var(--bg-color); color: var(--text);
        margin: 0; padding: 20px;
        display: flex; flex-direction: column; align-items: center; min-height: 100vh;
      }
      header { text-align: center; margin-bottom: 20px; }
      h1 { margin: 0; color: var(--text); font-size: 1.8rem; }
      p { color: #9a8c98; font-size: 0.9rem; margin-top: 5px; }
      
      .container {
        width: 100%; max-width: 500px;
        background: var(--card-bg); border-radius: 20px;
        box-shadow: 0 10px 25px rgba(226, 212, 212, 0.5);
        padding: 30px; box-sizing: border-box; text-align: center;
      }
      
      /* è¼¸å…¥æ¡†æ¨£å¼ */
      input {
        width: 100%; padding: 12px;
        border: 2px solid #eee; border-radius: 12px;
        font-size: 1rem; outline: none; box-sizing: border-box; margin-bottom: 10px;
      }
      input:focus { border-color: var(--secondary); }
      
      /* ğŸ”¥ å¼·åˆ¶æ—¥æ›†æ¨£å¼ (ç¦æ­¢æ‰‹æ‰“) */
      input[type="date"] {
          background-color: #fff;
          cursor: pointer;
          caret-color: transparent; /* éš±è—æ¸¸æ¨™ */
      }

      .btn {
        width: 100%; padding: 15px;
        border: none; border-radius: 12px;
        font-size: 1.1rem; font-weight: bold; cursor: pointer; margin-bottom: 10px;
        transition: transform 0.1s;
      }
      .btn:active { transform: scale(0.98); }
      .btn-primary { background-color: var(--secondary); color: white; }
      .btn-outline { background-color: white; border: 2px solid var(--secondary); color: var(--secondary); }
      .btn-delete { background: none; border: none; font-size: 1.2rem; cursor: pointer; opacity: 0.5; padding: 5px; flex: 0; }
      .btn-delete:hover { opacity: 1; color: var(--danger); }
      
      .page-section { display: none; }
      .active { display: block; }
      
      .code-display {
        font-size: 3rem; letter-spacing: 5px;
        color: var(--text);
        margin: 20px 0; font-weight: bold; border: 3px dashed var(--accent);
        padding: 10px; border-radius: 10px; background: #fffdf5;
      }
      
      /* æ¸…å–®æ¨£å¼ */
      .food-list { max-height: 400px; overflow-y: auto; text-align: left; margin-top: 15px;}
      .food-item {
        display: flex; justify-content: space-between;
        align-items: center;
        padding: 12px; margin-bottom: 10px; background: #fff;
        border: 1px solid #f0f0f0; border-radius: 12px;
      }
      .food-info { display: flex; flex-direction: column; }
      .food-name { font-size: 1.1rem; font-weight: bold; }
      .food-loc { font-size: 0.85rem; color: #888; }
      
      /* ğŸ”¥ å»ºç«‹è€…æ¨™ç±¤æ¨£å¼ */
      .creator-tag {
          font-size: 0.8rem;
          color: #555;
          background-color: #eef;
          padding: 2px 8px;
          border-radius: 10px;
          margin-left: 8px;
          border: 1px solid #dde;
      }

      .status-tag { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; color: white; text-align: center; }
      .bg-ok { background: var(--safe); color: #555; }
      .bg-soon { background: var(--accent); }
      .bg-bad { background: var(--danger); }
      
      .top-nav { display: flex; justify-content: space-between; margin-bottom: 15px; border-bottom: 2px dashed #eee; padding-bottom: 10px; font-size: 0.9rem;}
      #loader { display: none; color: #aaa; margin-top: 10px; font-size: 0.9rem; }
    </style>
  </head>
  <body>

    <header>
      <h1>é£Ÿå“å°ç®¡å®¶ ğŸ«</h1>
      <p>v9.2 æ™ºæ…§è¨˜æ†¶ç‰ˆ</p>
    </header>

    <div class="container">

      <div id="pageLanding" class="page-section active">
        <h2>æ­¡è¿ä½¿ç”¨</h2>
        <p>å·²æœ‰é€šè¡Œè­‰ï¼Ÿç›´æ¥ç™»å…¥ã€‚<br>ç¬¬ä¸€æ¬¡ä½¿ç”¨ï¼Ÿç«‹å³è¨»å†Šã€‚</p>
        <br>
        <button class="btn btn-primary" onclick="goToLogin()">ğŸ” æˆ‘æœ‰ä»£ç¢¼ (ç™»å…¥)</button>
        <button class="btn btn-outline" onclick="goToRegister()">âœ¨ æˆ‘è¦è¨»å†Š (éš¨æ©Ÿç”¢ç”Ÿ)</button>
      </div>

      <div id="pageRegister" class="page-section">
        <h2>æ­£åœ¨ç”¢ç”Ÿé€šè¡Œè­‰...</h2>
        <div id="newCodeDisplay" class="code-display">----</div>
        <p>è«‹è¨˜ä½é€™çµ„ä»£ç¢¼ï¼å®ƒæ˜¯ä½ é€²å…¥å†°ç®±çš„å”¯ä¸€é‘°åŒ™ã€‚</p>
        <button class="btn btn-primary" onclick="doLoginAfterReg()">ğŸš€ ç›´æ¥é€²å…¥</button>
      </div>

      <div id="pageLogin" class="page-section">
        <h2>è¼¸å…¥é€šè¡Œè­‰</h2>
        <input type="text" id="inputCode" placeholder="è«‹è¼¸å…¥ 4 ç¢¼ä»£ç¢¼" style="text-align:center; font-size: 1.5rem; text-transform:uppercase;">
        <button class="btn btn-primary" onclick="doVerifyLogin()">é€²å…¥å†°ç®±</button>
        <button class="btn btn-outline" onclick="goBack()">è¿”å›</button>
      </div>

      <div id="pageMain" class="page-section">
        <div class="top-nav">
          <span>ğŸ« ID: <b id="displayId">----</b></span>
          <span style="cursor:pointer; color: #888;" onclick="doLogout()">ç™»å‡º â”</span>
        </div>

        <input type="text" id="inCreator" list="creatorHistory" placeholder="ğŸ‘¤ è³¼è²·äºº (ä¾‹å¦‚: åª½åª½, å°æ˜)">
        <datalist id="creatorHistory"></datalist>

        <input type="text" id="inName" placeholder="ğŸ é£Ÿå“åç¨±">
        <input type="text" id="inLoc" placeholder="ğŸ§Š æ”¾ç½®ä½ç½®">
        
        <div style="position:relative; margin-bottom:10px;">
            <input type="date" id="inDate" onkeydown="return false;" onclick="try{this.showPicker()}catch(e){}" required>
            <div style="font-size:12px; color:#aaa; margin-top:-8px; margin-bottom:8px;">ğŸš« è«‹é»æ“Šä¸Šæ–¹é¸å–æ—¥æœŸ (ç¦æ­¢æ‰‹æ‰“)</div>
        </div>
        
        <button class="btn btn-primary" onclick="addData()">â• åŠ å…¥æ¸…å–®</button>

        <input type="text" id="searchIn" placeholder="ğŸ” æœå°‹..." onkeyup="filterList()" style="margin-top:20px;">
        <div id="loader">è³‡æ–™è®€å–ä¸­...</div>
        <div class="food-list" id="listArea"></div>
      </div>

    </div>

    <script>
      var myCode = "";
      var allFoodData = [];

      // å•Ÿå‹•æ™‚æª¢æŸ¥ç™»å…¥
      window.onload = function() {
        var savedCode = localStorage.getItem("my_fridge_code");
        if (savedCode) { verifyAndEnter(savedCode); }
      };

      // é é¢åˆ‡æ›
      function showPage(id) {
        document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active');
      }
      function goBack() { showPage('pageLanding'); }
      function goToLogin() { showPage('pageLogin'); }
      
      function goToRegister() {
        showPage('pageRegister');
        google.script.run.withSuccessHandler(function(code){
          document.getElementById('newCodeDisplay').innerText = code;
          myCode = code;
        }).registerNewUser();
      }
      
      function doLoginAfterReg() {
        localStorage.setItem("my_fridge_code", myCode);
        enterMainApp();
      }

      function doVerifyLogin() {
        var code = document.getElementById('inputCode').value.toUpperCase().trim();
        if(!code) return alert("è«‹è¼¸å…¥ä»£ç¢¼");
        verifyAndEnter(code);
      }

      function verifyAndEnter(code) {
        document.getElementById('loader').style.display = 'block';
        google.script.run.withSuccessHandler(function(isValid){
          document.getElementById('loader').style.display = 'none';
          if(isValid) {
            myCode = code;
            localStorage.setItem("my_fridge_code", myCode);
            enterMainApp();
          } else {
            alert("æ‰¾ä¸åˆ°é€™å€‹é€šè¡Œè­‰ä»£ç¢¼å–”ï¼");
            localStorage.removeItem("my_fridge_code");
            showPage('pageLogin');
          }
        }).loginUser(code);
      }

      function doLogout() {
        localStorage.removeItem("my_fridge_code");
        location.reload();
      }

      function enterMainApp() {
        showPage('pageMain');
        document.getElementById('displayId').innerText = myCode;
        loadData();
        loadCreators(); // è¼‰å…¥è³¼è²·äººæ­·å²
      }

      // ğŸ”¥ è¼‰å…¥è³¼è²·äººæ¸…å–® (æ™ºæ…§è¨˜æ†¶)
      function loadCreators() {
        google.script.run.withSuccessHandler(function(list){
          var dataList = document.getElementById('creatorHistory');
          dataList.innerHTML = "";
          if(list && list.length > 0) {
              list.forEach(name => {
                var option = document.createElement('option');
                option.value = name;
                dataList.appendChild(option);
              });
          }
        }).getCreatorHistory(myCode);
      }

      function loadData() {
        document.getElementById('loader').style.display = 'block';
        google.script.run.withSuccessHandler(renderList).getFoodData(myCode);
      }

      function renderList(data) {
        document.getElementById('loader').style.display = 'none';
        allFoodData = data;
        data.sort((a, b) => new Date(a.date) - new Date(b.date));
        
        var html = "";
        if (data.length === 0) html = "<div style='color:#ccc; margin-top:20px;'>ç›®å‰æ²’æœ‰è³‡æ–™</div>";
        var today = new Date(); today.setHours(0,0,0,0);
        
        data.forEach(item => {
          var parts = item.date.split('-');
          var expDate = new Date(parts[0], parts[1]-1, parts[2]);
          var diff = Math.ceil((expDate - today) / (86400000));
          var tagClass = "bg-ok"; var tagText = `å‰© ${diff} å¤©`;
          if (diff < 0) { tagClass = "bg-bad"; tagText = "å·²éæœŸ"; }
          else if (diff <= 3) { tagClass = "bg-soon"; tagText = "å¿«å£äº†"; }
          var displayDate = item.date.replace(/-/g, '/');
          
          // ğŸ”¥ é€™è£¡æœƒæŠŠè³¼è²·äººé¡¯ç¤ºå‡ºä¾†
          var creatorInfo = item.creator ? `<span class="creator-tag">ğŸ‘¤ ${item.creator}</span>` : "";

          html += `
            <div class="food-item">
              <div class="food-info">
                <div><span class="food-name">${item.name}</span>${creatorInfo}</div>
                <span class="food-loc">ğŸ“ ${item.location}</span>
              </div>
              <div style="display:flex; align-items:center; gap:10px;">
                <div class="status-tag ${tagClass}">${tagText}<br>${displayDate}</div>
                <button class="btn-delete" onclick="deleteData('${item.name}', '${item.location}', '${item.date}')">ğŸ—‘ï¸</button>
              </div>
            </div>`;
        });
        document.getElementById('listArea').innerHTML = html;
      }

      function addData() {
        var creator = document.getElementById('inCreator').value.trim(); // å–å¾—è³¼è²·äºº
        var name = document.getElementById('inName').value;
        var loc = document.getElementById('inLoc').value;
        var date = document.getElementById('inDate').value;
        
        if(!name || !date) return alert("åç¨±èˆ‡æ—¥æœŸå¿…å¡«");
        
        // å¹´ä»½é˜²å‘†
        var year = parseInt(date.split('-')[0]);
        if (year < 2000 || year > 2100) {
          alert("æ—¥æœŸå¤ªé™é å›‰ï¼(2000~2100)");
          return;
        }

        // å…ˆåœ¨å‰ç«¯æ›´æ–°é¡¯ç¤ºï¼Œæå‡é€Ÿåº¦æ„Ÿ
        var newItem = {name:name, location:loc, date:date, creator:creator};
        allFoodData.push(newItem);
        renderList(allFoodData); // é€™è£¡æœƒç«‹å³é¡¯ç¤ºå‡º creator

        // å³æ™‚æ›´æ–°è³¼è²·äººé¸å–®
        if(creator) {
           var dataList = document.getElementById('creatorHistory');
           var exists = false;
           for (var i=0; i<dataList.options.length; i++) {
               if (dataList.options[i].value == creator) exists = true;
           }
           if (!exists) {
               var option = document.createElement('option');
               option.value = creator;
               dataList.appendChild(option);
           }
        }

        // æ¸…ç©ºæ¬„ä½
        document.getElementById('inName').value = '';
        document.getElementById('inDate').value = '';
        
        // å‚³é€çµ¦å¾Œç«¯ (åŒ…å« creator)
        google.script.run.addFood(name, loc, date, myCode, creator, "");
      }

      function deleteData(name, loc, date) {
        if(!confirm("ç¢ºå®šåˆªé™¤å—ï¼Ÿ")) return;
        allFoodData = allFoodData.filter(i => !(i.name==name && i.location==loc && i.date==date));
        renderList(allFoodData);
        google.script.run.deleteFood(name, loc, date, myCode);
      }

      function filterList() {
        var k = document.getElementById('searchIn').value.toLowerCase();
        // æœå°‹ä¹ŸåŒ…å«è³¼è²·äºº
        var f = allFoodData.filter(i => 
            i.name.toLowerCase().includes(k) || 
            i.location.toLowerCase().includes(k) || 
            (i.creator && i.creator.toLowerCase().includes(k))
        );
        renderList(f);
      }
    </script>
  </body>
</html>
